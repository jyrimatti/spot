#!/bin/sh

# Returns the current spot price. Parameter 'tz' is optional, defaults to Europe/Helsinki.

source util.sh

getQuery

echo 'Content-Type: application/json'
echo 'Cache-Control: max-age=60, must-revalidate'
echo ''

export TZ=${var_tz:-'Europe/Helsinki'}

now=$(date +%s)
offset=$(date +%:z)

$(command -v sqlite3 || echo '/run/current-system/sw/bin/sqlite3') ./spot.db '.mode json' "
    SELECT strftime('%Y-%m-%dT%H:%M:%S${offset}', instant, 'unixepoch', 'localtime') startTime, centsPerKWh
    FROM spot
    WHERE instant <= '$now'
    ORDER BY instant DESC
    LIMIT 1" | sed 's/^\[//' | sed 's/\]$//'
