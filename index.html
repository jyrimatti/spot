<html>
  <head>
    <meta property="og:charset" content="UTF-8"/>
    <title>Spot prices in Finland</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-title" content="Spot"/>
    <meta name="application-name" content="Spot"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="mobile-web-app-capable" content="yes"/>
    <script src="https://cdn.amcharts.com/lib/version/5.4.1/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/version/5.4.1/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/version/5.4.1/themes/Animated.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <script src="web/dist/bundle.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
<body>
  <header>
    <span class="current" hx-get="/current.html?tax=24" hx-trigger="load, every 60s"></span>
    <select id="template">
      <option value="1" data-baseInterval="hour">Past month</option>
      <option value="2" data-baseInterval="hour">Past 3 months</option>
      <option value="3" data-baseInterval="hour">Past 6 months</option>
      <option value="4" data-baseInterval="hour">Past year</option>
      <option value="5" data-baseInterval="hour">All time</option>
      <option value="6" data-baseInterval="day">Daily averages</option>
      <option value="7" data-baseInterval="week">Weekly averages</option>
      <option value="8" data-baseInterval="month">Monthly averages</option>
      <option value="9" data-baseInterval="day">Daily minimums</option>
      <option value="10" data-baseInterval="week">Weekly minimums</option>
      <option value="11" data-baseInterval="month">Monthly minimums</option>
      <option value="12" data-baseInterval="day">Daily maximums</option>
      <option value="13" data-baseInterval="week">Weekly maximums</option>
      <option value="14" data-baseInterval="month">Monthly maximums</option>
    </select>
    <input id="query" value="SELECT * FROM spot WHERE instant BETWEEN strftime('%s', '{start}') AND strftime('%s', '{end}')" placeholder="your query here..." />
    <a href="api/">API docs</a>
    <a href="" title="&lt;a href='current.html'&gt;html&lt;/a&gt; | &lt;a href='current.csv'&gt;csv&lt;/a&gt; | &lt;a href='current.json'&gt;json&lt;/a&gt;">Current price</a>
    <a href="" title="&lt;a href='day.html?day={{today}}'&gt;html&lt;/a&gt; | &lt;a href='day.csv?day={{today}}'&gt;csv&lt;/a&gt; | &lt;a href='day.json?day={{today}}'&gt;json&lt;/a&gt;">Daily prices</a>
    <a href="" title="&lt;a href='window.html?window=3'&gt;html&lt;/a&gt; | &lt;a href='window.csv?window=3'&gt;csv&lt;/a&gt; | &lt;a href='window.json?window=3'&gt;json&lt;/a&gt;">Next window</a>
    <a class="github" href="https://github.com/jyrimatti/spot"><img src="github-mark.png" /></a>
  </header>
  <section class="container">
    <div id="chart"></div>
  </section>
  <script type="text/javascript" src="script.js"></script>
  <script>
    document.body.querySelectorAll('option').forEach(x => {
      if (x.getAttribute('value') == 1) {
        x.setAttribute('value', "SELECT * FROM spot WHERE instant BETWEEN strftime('%s', '" + addMonths(new Date(), -1).toISOString() + "') AND strftime('%s', '" + new Date().toISOString() + "')");
      } else if (x.getAttribute('value') == 2) {
        x.setAttribute('value', "SELECT * FROM spot WHERE instant BETWEEN strftime('%s', '" + addMonths(new Date(), -3).toISOString() + "') AND strftime('%s', '" + new Date().toISOString() + "')");
      } else if (x.getAttribute('value') == 3) {
        x.setAttribute('value', "SELECT * FROM spot WHERE instant BETWEEN strftime('%s', '" + addMonths(new Date(), -6).toISOString() + "') AND strftime('%s', '" + new Date().toISOString() + "')");
      } else if (x.getAttribute('value') == 4) {
        x.setAttribute('value', "SELECT * FROM spot WHERE instant BETWEEN strftime('%s', '" + addYears(new Date(), -1).toISOString() + "') AND strftime('%s', '" + new Date().toISOString() + "')");
      } else if (x.getAttribute('value') == 5) {
        x.setAttribute('value', "SELECT * FROM spot");
      } else if (x.getAttribute('value') == 6) {
        x.setAttribute('value', "SELECT AVG(centsPerKWh) centsPerKWh, instant FROM spot group by strftime('%Y-%m-%d', instant, 'unixepoch')");
      } else if (x.getAttribute('value') == 7) {
        x.setAttribute('value', "SELECT AVG(centsPerKWh) centsPerKWh, instant FROM spot group by strftime('%Y-%W', instant, 'unixepoch')");
      } else if (x.getAttribute('value') == 8) {
        x.setAttribute('value', "SELECT AVG(centsPerKWh) centsPerKWh, instant FROM spot group by strftime('%Y-%m', instant, 'unixepoch')");
      } else if (x.getAttribute('value') == 9) {
        x.setAttribute('value', "SELECT MIN(centsPerKWh) centsPerKWh, instant FROM spot group by strftime('%Y-%m-%d', instant, 'unixepoch')");
      } else if (x.getAttribute('value') == 10) {
        x.setAttribute('value', "SELECT MIN(centsPerKWh) centsPerKWh, instant FROM spot group by strftime('%Y-%W', instant, 'unixepoch')");
      } else if (x.getAttribute('value') == 11) {
        x.setAttribute('value', "SELECT MIN(centsPerKWh) centsPerKWh, instant FROM spot group by strftime('%Y-%m', instant, 'unixepoch')");
      } else if (x.getAttribute('value') == 12) {
        x.setAttribute('value', "SELECT MAX(centsPerKWh) centsPerKWh, instant FROM spot group by strftime('%Y-%m-%d', instant, 'unixepoch')");
      } else if (x.getAttribute('value') == 13) {
        x.setAttribute('value', "SELECT MAX(centsPerKWh) centsPerKWh, instant FROM spot group by strftime('%Y-%W', instant, 'unixepoch')");
      } else if (x.getAttribute('value') == 14) {
        x.setAttribute('value', "SELECT MAX(centsPerKWh) centsPerKWh, instant FROM spot group by strftime('%Y-%m', instant, 'unixepoch')");
      }
    });
    document.getElementById('template').onchange = function() {
      document.getElementById('query').value = this.value;
      document.getElementById('query').dispatchEvent(new Event('change'));
    };

    document.body.querySelectorAll('[title]').forEach(x => {
      x.setAttribute('title', x.getAttribute('title').replaceAll('{{today}}', new Date().toISOString().slice(0, 10)));
    });

    tippy(document.body.querySelectorAll('[title]'), {
      allowHTML: true,
      interactive: true,
      theme: 'light',
      content(reference) {
          const title = reference.getAttribute('title');
          reference.removeAttribute('title');
          return title;
      }
  });
  </script>
</body>
</html>

